<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>ğŸ›°ï¸ Intrusion Detection Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://unpkg.com/globe.gl@2.32.3/dist/globe.gl.min.js"></script>

  <!-- Styling -->
  <style>
    body {
      background: #0d1117;
      color: #f0f0f0;
      font-family: 'Segoe UI', sans-serif;
    }
    .container { margin-top: 20px; }
    .card { background: #161b22; color: white; border: 1px solid #30363d; margin-bottom: 20px; }
    .card-header { background: #21262d; font-weight: bold; border-bottom: 1px solid #30363d; }
    #globeViz {
      width: 100%;
      height: 600px;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      border: 1px solid #30363d;
      background-color: #0d1117;
    }
    #globeViz canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      position: absolute !important;
      top: -10% !important;
      left: -25% !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">ğŸ›¡ï¸ Intrusion Detection System Dashboard</h2>
    <div class="text-center mb-4">
      <a href="/export_logs" class="btn btn-outline-light">â¬‡ï¸ Export Logs</a>
      <a href="/simulate" class="btn btn-outline-warning">âš™ï¸ Simulate Attack</a>
      <a href="/simulate_bulk" class="btn btn-outline-success">ğŸŒ Simulate 20 Global Attacks</a>

      <a href="/clear_logs" class="btn btn-outline-danger">ğŸ—‘ï¸ Clear Logs</a>
    </div>

    <div class="row">
      <div class="col-md-7">
        <div class="card">
          <div class="card-header">ğŸ“Š Live Traffic Graph</div>
          <div class="card-body"><img id="trafficImg" src="/graph" alt="Traffic Graph" class="img-fluid"></div>
        </div>
        <div class="card">
          <div class="card-header">ğŸŒ Live IP Globe Map</div>
          <div class="card-body"><div id="globeViz"></div></div>
        </div>
      </div>

      <div class="col-md-5">
        <div class="card overflow-auto" style="max-height: 300px;">
          <div class="card-header">ğŸ“¡ Active IP Traffic</div>
          <div class="card-body"><ul id="ipList" class="list-group"></ul></div>
        </div>
        <div class="card overflow-auto" style="max-height: 300px;">
          <div class="card-header">â›” Blocked IPs</div>
          <div class="card-body"><ul id="blockedList" class="list-group"></ul></div>
        </div>
        <div class="card">
          <div class="card-header">ğŸ”“ Unblock IP</div>
          <div class="card-body">
            <form id="unblockForm">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Enter IP to unblock" id="unblockInput">
                <button class="btn btn-danger" type="submit">Unblock</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Refresh scripts -->
  <script>
    function refreshGraph() {
      document.getElementById("trafficImg").src = "/graph?ts=" + Date.now();
    }
    function refreshList(url, elementId, badgeClass = 'bg-success') {
      fetch(url).then(r => r.json()).then(data => {
        const node = document.getElementById(elementId);
        node.innerHTML = '';
        for (const [ip, cnt] of Object.entries(data)) {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<strong>${ip}</strong> <span class="badge ${badgeClass}">${cnt}</span>`;
          node.appendChild(li);
        }
      });
    }
    function refreshBlocked() {
      fetch('/blocked_ips').then(r => r.json()).then(data => {
        const node = document.getElementById('blockedList');
        node.innerHTML = '';
        data.forEach(ip => {
          const li = document.createElement('li');
          li.className = 'list-group-item text-danger';
          li.textContent = ip;
          node.appendChild(li);
        });
      });
    }
    document.getElementById('unblockForm').addEventListener('submit', e => {
      e.preventDefault();
      const ip = document.getElementById('unblockInput').value.trim();
      if (ip) fetch('/unblock_ip', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `ip=${encodeURIComponent(ip)}`
      }).then(() => refreshBlocked());
    });
    setInterval(refreshGraph, 3000);
    setInterval(() => refreshList('/live_ips', 'ipList'), 3000);
    setInterval(refreshBlocked, 3000);
    console.log("ğŸ”¥ JS loaded!");

  </script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('globeViz');
    if (!container) return console.error('âŒ globeViz not found');

    const globe = Globe()(container)
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
      .backgroundColor('#0d1117')
      .arcColor(() => '#39ff14')
      .arcAltitude(0.3)
      .arcDashLength(0.4)
      .arcDashGap(1)
      .arcDashAnimateTime(4000)
      .arcLabel(d => d.label)
      .arcsTransitionDuration(0);

    // Enable rotation
    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.4;

    function updateGlobeFlows() {
      fetch('/ip_flows')
        .then(res => res.json())
        .then(flows => {
          console.log("ğŸŒ Live Flows:", flows);

          const unique = new Set();
          const arcs = [];

          flows.forEach(f => {
            const key = `${f.src_ip}->${f.dst_ip}`;
            if (!unique.has(key) && f.src_coords && f.dst_coords) {
              unique.add(key);
              arcs.push({
                startLat: f.src_coords[0],
                startLng: f.src_coords[1],
                endLat: f.dst_coords[0],
                endLng: f.dst_coords[1],
                label: `${f.src_ip} â†’ ${f.dst_ip}`
              });
            }
          });

          globe.arcsData(arcs); // âœ… Only arcs, no points
        })
        .catch(err => console.error('âŒ Error loading IP flows:', err));
    }

    updateGlobeFlows();
    setInterval(updateGlobeFlows, 5000);
  });
</script>


</body>
</html>
